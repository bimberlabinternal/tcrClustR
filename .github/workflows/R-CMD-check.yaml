on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]
  pull_request:
  schedule:
    - cron: "0 6 10 * *"

name: R Build and Checks

jobs:
  R-CMD-check:
    runs-on: ubuntu-${{ matrix.config.os }}

    name: ubuntu-${{ matrix.config.os }} (${{ matrix.config.r }} / ${{ matrix.config.bioc }})

    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: 24.04, r: '4.4', bioc: '3.20', pkgdown: "true" }

    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: bimberlabinternal/DevOps/githubActions/r-gh-setup@master
        with:
          r_version: ${{ matrix.config.r }}
          bioc_version: ${{ matrix.config.bioc }}
          cache_version: ${{ secrets.CACHE_VERSION }}
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

      - uses: r-lib/actions/check-r-package@v2
        with:
          args: 'c("--no-manual")'
        env:
          _R_CHECK_CRAN_INCOMING_: false


       - name: Install pypi python packages
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update && sudo apt-get install -yq python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install --user wheel setuptools
          mkdir -p ~/.config/matplotlib
          echo "backend: Agg" > ~/.config/matplotlib/matplotlibrc
          python3 -m pip install --no-cache-dir numpy scipy matplotlib
          python3 -m pip --no-cache-dir install scikit-learn scikit-misc tqdm sympy setuptools pandas pyyaml scanpy rpy2
          python3 -m pip --no-cache-dir install git+https://github.com/kmayerb/tcrdist3.git@0.2.2

      - name: Setup CoNGA
        run: |
          cd ../
          git clone https://github.com/phbradley/conga.git conga
          cd conga/tcrdist_cpp
          make
          cd ../../
          pip3 install -e conga

      - name: Install package
        if: github.ref == 'refs/heads/main' && matrix.config.pkgdown == 'true'
        run: R CMD INSTALL .

      - name: Deploy package
        if: github.ref == 'refs/heads/main' && matrix.config.pkgdown == 'true'
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          Rscript -e 'pkgdown::deploy_to_branch(new_process = FALSE, clean = TRUE)'
